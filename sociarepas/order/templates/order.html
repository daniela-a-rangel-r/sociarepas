{% extends 'home.html' %}
{% block content %}
{% load static %}

<div class="head-title d-flex align-items-center justify-content-between" style="gap: 20px;">
    <div class="left d-flex align-items-center" style="gap: 20px;">
        <h1 style="margin-bottom: 0;">Pedidos</h1>
        <input id="searchInput" type="text" class="form-control" placeholder="Buscar arepa..."
            style="max-width: 250px;">
        <button class="btn btn-outline-primary" type="button" id="cartButton"
            style="display: flex; align-items: center;">
            <i class='bx bx-cart' style="font-size: 1.5rem;"></i>
        </button>
    </div>
</div>

<div class="cards-container" id="cardsContainer">
    {% for food in food_types %}
    <div class="order-card">
        <div class="order-user">
            <img src="{% static 'assets/img/logo-arepa.svg' %}" alt="Arepa">
            <p class="order-title">{{ food.name }}</p>
        </div>
        <div class="order-date">
            <strong>Precio:</strong> {{ food.price }} $
        </div>
        <div class="order-actions d-flex align-items-center" style="gap: 10px;">
            <div class="counter d-flex align-items-center">
                <button type="button" class="btn btn-outline-secondary btn-sm btn-counter"
                    onclick="decrement(this)">-</button>
                <span class="mx-2 counter-value">1</span>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-counter"
                    onclick="increment(this)">+</button>
            </div>
            <button class="btn btn-primary btn-sm" onclick="addToCart(this)">Añadir</button>
        </div>
    </div>


    <!-- Modal Carrito -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel">Carrito de compras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="cart-items" class="table-responsive"></div>
                    <span id="cart-empty-msg">Sin arepas añadidas</span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="showClientModal()">Ordenar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spinner de carga -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-transparent border-0 shadow-none">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
                    <div class="mt-3 fw-bold text-primary">Procesando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Datos del Cliente -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="clientModalLabel">Datos del cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="clientForm" autocomplete="off">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido</label>
                                <input type="text" class="form-control" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Dirección</label>
                                <input type="text" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Número telefónico</label>
                                <input type="tel" class="form-control" required>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <span class="fw-bold fs-5">Total a pagar:</span>
                            <span class="fw-bold fs-4 text-success" id="clientModalTotal">0.00 $</span>
                        </div>

                        <div class="modal-footer d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="backToCart()">Volver</button>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class='bx bx-credit-card'></i> Pagar
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    {% empty %}
    <p>No hay tipos de arepas registrados.</p>
    {% endfor %}
</div>


<!-- estilo de las cartas -->
<style>
    .cards-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 30px;
    }

    .order-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        padding: 20px;
        width: 260px;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .order-card:hover {
        transform: translateY(-10px) scale(1.03);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
    }

    .order-user {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .order-user img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #eee;
    }

    .order-date {
        margin-bottom: 10px;
        color: #555;
    }

    .order-actions {
        margin-top: 10px;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .counter {
        display: flex;
        align-items: center;
        gap: 5px;
        background: #f5f5f5;
        border-radius: 8px;
        padding: 2px 8px;
    }

    .counter-value {
        min-width: 20px;
        text-align: center;
        font-weight: bold;
    }
</style>

<!-- Ajusta el CSS para los botones -->
<style>
    /* ...tu CSS existente... */

    /* Ajuste para la columna de acción en la tabla del carrito */
    #cart-items .table td .btn {
        min-width: 36px;
        margin-bottom: 2px;
    }

    #cart-items .table td {
        vertical-align: middle;
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        .modal-lg {
            max-width: 98vw;
        }

        #cart-items .table th,
        #cart-items .table td {
            font-size: 0.95rem;
            padding: 0.4rem;
        }
    }
</style>

<!-- Esto ayuda si hay muchas columnas -->
<style>
    #cart-items.table-responsive {
        overflow-x: auto;
    }
</style>

<!-- Contador de arepas  -->
<script>
    function increment(btn) {
        const counterValue = btn.parentElement.querySelector('.counter-value');
        let value = parseInt(counterValue.textContent);
        counterValue.textContent = value + 1;
    }

    function decrement(btn) {
        const counterValue = btn.parentElement.querySelector('.counter-value');
        let value = parseInt(counterValue.textContent);
        if (value > 1) {
            counterValue.textContent = value - 1;
        }
    }

    // Filtro de cartas por nombre
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const cards = document.querySelectorAll('.order-card');

        searchInput.addEventListener('input', function () {
            const filter = searchInput.value.toLowerCase();
            cards.forEach(card => {
                const title = card.querySelector('.order-title').textContent.toLowerCase();
                if (title.includes(filter)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
</script>

<!-- Inicializar modal de carrto -->
<script>
    // Mostrar modal al hacer clic en el carrito
    document.addEventListener('DOMContentLoaded', function () {
        const cartButton = document.getElementById('cartButton');
        cartButton.addEventListener('click', function () {
            var cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            cartModal.show();
        });
    });
</script>


<!-- Script para manejar el carrito y los valores introducidos -->
<script>
    // Carrito en memoria
    let cart = {};

    // Función para añadir productos al carrito
    function addToCart(btn) {
        const card = btn.closest('.order-card');
        const title = card.querySelector('.order-title').textContent;
        const imgSrc = card.querySelector('img').src;
        const quantity = parseInt(card.querySelector('.counter-value').textContent);
        // Obtener el precio desde el texto (ej: "Precio: 10 $")
        const priceText = card.querySelector('.order-date').textContent;
        const price = parseFloat(priceText.replace(/[^\d.]/g, ''));

        if (cart[title]) {
            cart[title].quantity += quantity;
        } else {
            cart[title] = {
                img: imgSrc,
                quantity: quantity,
                price: price
            };
        }
        updateCartModal();
    }

    // Eliminar producto del carrito
    function removeFromCart(title) {
        delete cart[title];
        updateCartModal();
    }

    // Disminuir cantidad desde el carrito
    function decreaseFromCart(title) {
        if (cart[title]) {
            if (cart[title].quantity > 1) {
                cart[title].quantity -= 1;
            } else {
                delete cart[title];
            }
            updateCartModal();
        }
    }

    // Actualiza el contenido del modal del carrito con formato tabla y total
    function updateCartModal() {
        const cartItems = document.getElementById('cart-items');
        const emptyMsg = document.getElementById('cart-empty-msg');
        cartItems.innerHTML = '';

        const keys = Object.keys(cart);
        let total = 0;
        if (keys.length === 0) {
            emptyMsg.style.display = '';
        } else {
            emptyMsg.style.display = 'none';
            // Tabla
            let table = document.createElement('table');
            table.className = "table table-bordered align-middle mb-0";
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Imagen</th>
                        <th>Arepa</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            keys.forEach(title => {
                const item = cart[title];
                const subtotal = item.price * item.quantity;
                total += subtotal;
                let row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${item.img}" alt="Arepa" style="width:32px;height:32px;border-radius:50%;background:#eee;"></td>
                    <td>${title}</td>
                    <td><span class="badge bg-primary">${item.quantity}</span></td>
                    <td>${subtotal.toFixed(2)} $</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="decreaseFromCart('${title.replace(/'/g, "\\'")}')">
                            <i class='bx bx-minus'></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeFromCart('${title.replace(/'/g, "\\'")}')">
                            <i class='bx bx-x'></i>
                        </button>
                    </td>
                `;
                table.querySelector('tbody').appendChild(row);
            });
            // Fila de total
            let totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td colspan="3" class="text-end fw-bold">Total</td>
                <td colspan="2" class="fw-bold">${total.toFixed(2)} $</td>
            `;
            table.querySelector('tbody').appendChild(totalRow);

            cartItems.appendChild(table);
        }
    }
</script>

<script>
    // ...tu código existente...

    // Mostrar modal de datos del cliente con animación de carga
    function showClientModal() {
        // Cierra el modal del carrito
        var cartModal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
        cartModal.hide();

        // Muestra el spinner de carga
        var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();

        // Espera 1.2 segundos y muestra la modal de datos del cliente
        setTimeout(function () {
            loadingModal.hide();
            // Actualiza el total en la modal de cliente
            document.getElementById('clientModalTotal').textContent = getCartTotal() + ' $';
            var clientModal = new bootstrap.Modal(document.getElementById('clientModal'));
            clientModal.show();
        }, 1200);
    }

    // Calcula el total del carrito
    function getCartTotal() {
        let total = 0;
        Object.values(cart).forEach(item => {
            total += item.price * item.quantity;
        });
        return total.toFixed(2);
    }

    // Opcional: Manejar el envío del formulario de pago
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('clientForm').addEventListener('submit', function (e) {
            e.preventDefault();
            // Aquí puedes agregar la lógica de pago o mostrar otra animación
            alert('¡Pago realizado con éxito!');
            // Cierra la modal
            var clientModal = bootstrap.Modal.getInstance(document.getElementById('clientModal'));
            clientModal.hide();
        });
    });
</script>

<script>
function backToCart() {
    // Cierra la modal de cliente
    var clientModal = bootstrap.Modal.getInstance(document.getElementById('clientModal'));
    clientModal.hide();
    // Abre la modal del carrito
    setTimeout(function () {
        var cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
        cartModal.show();
    }, 400); // Espera breve para evitar conflicto de animaciones
}
</script>
{% endblock %}

{% block extra_js %}
{% endblock %}